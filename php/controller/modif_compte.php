<?php 	/* Inclusion de la classe "User" */	require_once "php/model/User.php";	/* Inclusion du fichier de connexion à la BD */	include_once "php/controller/connect-bd.php";	if (isset($_POST['id']) && !empty($_POST['id'])) {			/* Si toutes les données existent et ne sont pas vides */		if (is_uploaded_file($_FILES['avatar']['tmp_name']) && 		    isset($_POST['actual_pass']) && !empty($_POST['actual_pass']) &&			isset($_POST['new_pass']) && !empty($_POST['new_pass']) &&			isset($_POST['new_pass_confirm']) && !empty($_POST['new_pass_confirm']))		{						/* Protection des données */			$actual_pass = htmlspecialchars($_POST['actual_pass']);			$new_pass = htmlspecialchars($_POST['new_pass']);			$new_pass_confirm = htmlspecialchars($_POST['new_pass_confirm']);			$id_user = $_POST['id'];				/* Si les deux mots de passe sont identiques */			if ($new_pass == $new_pass_confirm)			{				$mdp = $actual_pass . 'graindeselpourlasecurite';								$mdp_actuel = sha1($mdp);								$user = new User($bdd);								$valid = $user->verifierMdp($id_user, $mdp_actuel);								if ($valid) 				{					$mdp_complet = $new_pass . 'graindeselpourlasecurite';					$mdp_crypt = sha1($mdp_complet);										$change = $user->modifierMdp($id_user, $mdp_crypt);										if ($change)					{						/* Préparation de l'upload */						$code = md5(uniqid(rand(), true));						$extensions = array('png', 'jpg', 'jpeg');						$ext = strtolower(substr(strrchr($_FILES['avatar']['name'],'.'),1));									/* Verif 1 : Si l'extension est incorrect */						if(!in_array($ext, $extensions))						{							 $style = 'style="display: block;"';						     $erreur = 'Le format du fichier est incorrect.';						}									/* Verif 2 : Si la taille est incorrecte */						if($_FILES['avatar']['size'] > 2097152)						{						   $style = 'style="display: block;"';						   $erreur = 'La taille du fichier est supérieur à 2 Mo.';						}												if(!isset($erreur))						{							 $fichier = $code . '.' . $ext;						     $dossier = 'img/avatar/' . $fichier;									     if(move_uploaded_file($_FILES['avatar']['tmp_name'], $dossier))						     {						     	$user = new User($bdd);								$avatar = $user->ajouterAvatar($fichier, $id_user);											if ($avatar) {									header('Location: compte.php?succ=ok');								}								else 								{									$style = 'style="display: block;"';									$erreur = 'Erreur de base de données. Merci de réessayer.';								}							 }							 else 							 {							 	$style = 'style="display: block;"';							 	$erreur = 'Erreur de déplacement de fichier. Merci de réessayer.';							 }						}					}					else 					{						$style = 'style="display: block;"';						$erreur = 'Une erreur est survenue. Merci de réessayer.';					}				}				else 				{					$style = 'style="display: block;"';					$erreur = 'Le mot de passe actuel est incorrect.';				}			}			else			{				$style = 'style="display: block;"';				$erreur = 'Le nouveau mot de passe et la confirmation ne sont pas identiques.';			}		}				else if (isset($_POST['actual_pass']) && !empty($_POST['actual_pass']) &&				 isset($_POST['new_pass']) && !empty($_POST['new_pass']) &&				 isset($_POST['new_pass_confirm']) && !empty($_POST['new_pass_confirm']))		{						/* Protection des données */			$actual_pass = htmlspecialchars($_POST['actual_pass']);			$new_pass = htmlspecialchars($_POST['new_pass']);			$new_pass_confirm = htmlspecialchars($_POST['new_pass_confirm']);			$id_user = $_POST['id'];				/* Si les deux mots de passe sont identiques */			if ($new_pass == $new_pass_confirm)			{				$mdp = $actual_pass . 'graindeselpourlasecurite';								$mdp_actuel = sha1($mdp);								$user = new User($bdd);								$valid = $user->verifierMdp($id_user, $mdp_actuel);								if ($valid) 				{					$mdp_complet = $new_pass . 'graindeselpourlasecurite';					$mdp_crypt = sha1($mdp_complet);										$change = $user->modifierMdp($id_user, $mdp_crypt);										if ($change)					{															header('Location: compte.php?succ=ok');					}					else 					{						$style = 'style="display: block;"';						$erreur = 'Une erreur est survenue. Merci de réessayer.';					}				}				else 				{					$style = 'style="display: block;"';					$erreur = 'Le mot de passe actuel est incorrect.';				}			}			else			{				$style = 'style="display: block;"';				$erreur = 'Le nouveau mot de passe et la confirmation ne sont pas identiques.';			}		}				else if (is_uploaded_file($_FILES['avatar']['tmp_name']))		{			$id_user = $_POST['id'];						/* Préparation de l'upload */			$code = md5(uniqid(rand(), true));			$extensions = array('png', 'jpg', 'jpeg');			$ext = strtolower(substr(strrchr($_FILES['avatar']['name'],'.'),1));			/* Verif 1 : Si l'extension est incorrect */			if(!in_array($ext, $extensions))			{				 $style = 'style="display: block;"';			     $erreur = 'Le format du fichier est incorrect.';			}			/* Verif 2 : Si la taille est incorrecte */			if($_FILES['avatar']['size'] > 2097152)			{			   $style = 'style="display: block;"';			   $erreur = 'La taille du fichier est supérieur à 2 Mo.';			}						if(!isset($erreur))			{				 $fichier = $code . '.' . $ext;			     $dossier = 'img/avatar/' . $fichier;			     if(move_uploaded_file($_FILES['avatar']['tmp_name'], $dossier)) 			     { 			     	$user = new User($bdd); 					$avatar = $user->ajouterAvatar($fichier, $id_user);  					if ($avatar) { 						header('Location: compte.php?succ=ok'); 					} 					else  					{ 						$style = 'style="display: block;"'; 						$erreur = 'Erreur de base de données.'; 					} 				 } 				 else  				 { 				 	$style = 'style="display: block;"'; 				 	$erreur = 'Erreur de déplacement de fichier. Merci de réessayer.'; 				 }			}		}				else		{			$style = 'style="display: block;"';			$erreur = 'Le formulaire est incomplet.';		}	}?>