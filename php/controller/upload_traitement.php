<?php	error_reporting(E_ALL);	ini_set('display_errors', '1');		/* Inclusion de la classe Gallerie.php */	require_once "php/model/Gallerie.php";	/* Inclusion de la classe Image.php */	require_once "php/model/Image.php";	/* Inclusion du fichier de connexion à la BD */	include_once "php/controller/connect-bd.php";	/* Si le formulaire d'upload est soumis */	if (isset($_POST['form']) && $_POST['form'] == "upload")	{		/* Si toutes les données existent et ne sont pas vides */		if (isset($_FILES['image']) &&			isset($_POST['titre_img']) && !empty($_POST['titre_img']) &&			isset($_POST['description_img']) && !empty($_POST['description_img']) &&			isset($_POST['is_public_img']) && !empty($_POST['is_public_img']) &&			isset($_POST['theme_img']) && !empty($_POST['theme_img']))		{			/* Protection des données */			$titre = htmlspecialchars($_POST['titre_img'], ENT_NOQUOTES);			$description = htmlspecialchars($_POST['description_img'], ENT_NOQUOTES);			$theme = $_POST['theme_img'];			$confidentialite = $_POST['is_public_img'];			$id_user = $_SESSION['user']['id_user'];			/* Préparation de l'upload */			$code = md5(uniqid(rand(), true));			$extensions = array('png', 'gif', 'jpg', 'jpeg');			$ext = strtolower(substr(strrchr($_FILES['image']['name'],'.'),1));			/* Verif 1 : Si l'extension est incorrect */			if(!in_array($ext, $extensions))			{				 $style = 'style="display: block;"';			     $erreur = 'Le format du fichier est incorrect.';			}			/* Verif 2 : Si la taille est incorrecte */			if($_FILES['image']['size'] > 5242880)			{			   $style = 'style="display: block;"';			   $erreur = 'La taille du fichier est supérieur à 5 Mo.';			}			if(!isset($erreur))			{				 $fichier = $code . '.' . $ext;			     $dossier = 'img/upload/' . $fichier;			     if(move_uploaded_file($_FILES['image']['tmp_name'], $dossier))			     {			     				     	/******* REDIMENSIONNEMENT ET UPLOAD DE L'IMAGE POUR LE SLIDER ****** */			     				     	switch ($ext) {			     				     		case "jpeg":			     			$img_src_resource = imagecreatefromjpeg($dossier);			     			break;			     					     		case "jpg":			     			$img_src_resource = imagecreatefromjpeg($dossier);			     			break;			     					     		case "png":		     				$img_src_resource = imagecreatefrompng($dossier);		     				break;			     					     		case "gif":		     				$img_src_resource = imagecreatefromgif($dossier);		     				break;			     				     	}			     				     	$new_img = imagecreatetruecolor(100, 100);			     				     	list($width, $height) = getimagesize($dossier);			     				     	imagecopyresampled($new_img, $img_src_resource, 0, 0, 0, 0, 100, 100, $width, $height);			     				     	switch ($ext) {			     				     			case "jpeg":		     				imagejpeg($new_img, 'img/upload/mini/' . $fichier);		     				break;		     					     			case "jpg":		     				imagejpeg($new_img, 'img/upload/mini/' . $fichier);		     				break;		     					     			case "png":		     				imagepng($new_img, 'img/upload/mini/' . $fichier);		     				break;		     					     			case "gif":		     				imagegif($new_img, 'img/upload/mini/' . $fichier);		     				break;			     					     	}			     				     	imagedestroy($new_img);			     				     	/********************************************************************** */				     	     				     						$img = new Image($bdd);					$new_id_img = $img->newImage($fichier, $titre, $description, $theme, $confidentialite, $id_user);					$gal = new Gallerie($bdd);					$link_success = $gal->linkGalleryTo($id_user, $new_id_img['id_img']);					if ($link_success) {						header('Location: php/view/confirmation_upload.php?msg=OK');					}			     }			     else			     {			          header('Location: php/view/confirmation_upload.php?msg=ERR');			     }			}		}		else		{			$style = 'style="display: block;"';			$erreur = "Le formulaire est incomplet.";		}	}?>